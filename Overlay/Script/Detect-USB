#!/bin/sh

set -e
usbFlagFile="/songsFile/USBDetectFlag_File.conf"
songs="/songsFile/Songs_NamesFile"
# read the file content

if [ ! -f $usbFlag ] ; then
  touch $usbFlag
  chmod 777 $usbFlag
  echo "DetectUSBFlag=0" > $usbFlagFile
fi

no_of_songs_system=$(find / -name "*.mp3" | wc -l)
echo $no_of_songs_system

counter=0
search2=0
search1=0
USBFlag=0

while true; do
  sleep 1                                         
                                                      
  search=$(find /dev/sd*)                             
    if  [[  -z $search  ]] ; then                     
        echo "no USB Found"                           
        if [[  $USBFlag  -eq 1 ]] ; then              
                echo "DetectUSBFlag=1" >  $usbFlagFile
                USBFlag=0                             
        fi                                            
   else #something now is connected                   
        echo "connect"                                
                                                      
        if [  "$counter" -eq 1 ] ; then               
                counter=0                             
                search1=$search                       
                                                      
        else                                                        
                counter=$(($counter+1))                                        
                search2=$search                                                
                                                                               
        fi                                                                     
        if ! [  "$search1" = "$search2"  ] ; then # a change happens 
                 partitions="$(fdisk -l /dev/sd* | grep -v 'Unknown' | grep -v 'Empty' | awk '/\/dev\/sd/ {print $2}' | sed 's/.$//' | grep '/dev')"
                 #partitions="$(ls /dev/sd*)" 2> /dev/null                      
                                                                               
            for partition in $partitions; do                                   
                echo "partition"                                               
                echo $partition                                                
                echo "mount"                                                   
                mountpoint="/media/$(basename $partition)"                     
                mkdir -p $mountpoint                                           
                error=1                                                        
                mount -r $partition $mountpoint 2>/dev/null && error=0         
                echo "after mount"                                             
                if [ $error -eq 1 ] ; then                                     
                  continue                                                     
                fi                                                             
                find $mountpoint -iname "*mp3" >> $songs                       
                no_of_songs_media=$(find $mountpoint -name "*.mp3" | wc -l)    
                #size="$(fdisk -l "$partition" | grep -v 'Unknown' | grep -v 'Em
                #size=$[ $size / (1024*1024) ] # Bytes to MB                    
                #wall -n "Detected device $partition with size = $size MB"      
                #espeak -g15 -s130 -ven-us+f1 " $no_of_songs_media mp3 songs Foun
                echo no_of_songs_media                                          
                echo "DetectUSBFlag=1" >  $usbFlagFile   
                USBFlag=1                                                       
           done                                                                 
        else                                                                    
          echo "unknown"                                                        
        fi                                                                      
  fi                                                                            
done     
