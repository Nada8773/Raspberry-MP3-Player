#!/bin/sh
set -e

PLAYER="/media"
songs="/songsFile/Songs_NamesFile"
usbFlag="/songsFile/USBDetectFlag_File.conf"


test -d ${PLAYER} || exit 1

mkdir -p /songsFile

# Remove file if exist
if [ -f  songs ] ; then
    rm $songs
fi


functionToSetArrayOfMusic(){

CommandLine=0
song_counter=0
CommandLine=0                               
song_counter=0                              
Song_Number=1                               
Min_NumberOfSong=1                          
button_state=0                              
FirstTimeFlag=0                             
PlayingFlag=0               
                            
                            
# Remove file if exist      
                            
# find the songs in media folder
find $PLAYER -iname "*mp3" | while read song
do                                          
          echo "$song">> $songs             
          echo $song                        
done                                        
song_counter=$( wc -l < $songs )            
}                                           
                                            
functionToSetArrayOfMusic 
if [ ! -f  $usbFlag ] ; then                
    echo "DetectUSBFlag=0" > $usbFlag       
    chmod 777 $usbFlag                      
fi                                          
                                            
                                            
if [ ! -d /sys/class/gpio/gpio4 ] ; then # check if export process has done befo
     # Ask kernal to export the virtual file to control gpio                    
    echo "4" > /sys/class/gpio/export                                           
    # Set pin direction as input                                                
    echo "in" > /sys/class/gpio/gpio4/direction                                 
fi                                                                              
if [ ! -d /sys/class/gpio/gpio17 ] ; then # check if export process has done bef
     # Ask kernal to export the virtual file to control gpio                    
    echo "17" > /sys/class/gpio/export                                          
 # Set pin direction as input                                                   
    echo "in" > /sys/class/gpio/gpio17/direction                                
fi                                                                              
if [ ! -d /sys/class/gpio/gpio18 ] ; then # check if export process has done bef
     # Ask kernal to export the virtual file to control gpio                    
    echo "18" > /sys/class/gpio/export                                          
    # Set pin direction as input  
    # Set pin direction as input                                                
    echo "in" > /sys/class/gpio/gpio18/direction                                
fi                                                                              
if [ ! -d /sys/class/gpio/gpio27 ] ; then # check if export process has done bef
     # Ask kernal to export the virtual file to control gpio                    
    echo "27" > /sys/class/gpio/export                                          
    # Set pin direction as input                                                
    echo "in" > /sys/class/gpio/gpio27/direction                                
fi                                                                              
                                                                                
                                                                                
while true                                                                      
do                                                                              
                                                                                
  # read the file content                                                       
  source $usbFlag                                                               
  if [[  $DetectUSBFlag -eq 1  ]] ; then                                        
    echo "USB Detected"                                                         
    echo "Begain to load the songs from it"                                     
    functionToSetArrayOfMusic                                                   
    echo "DetectUSBFlag=0" > $usbFlag                                           
  fi                                                                            
   #check if running the script without choosing any option                     
  if [[ -z $1 ]];then                                                           
        CommandLine=0          #button as input                                 
  else                                                                          
       CommandLine=1           #command line as input                           
       choice=$1                                                                
       read choice                                                              
  fi                                                                            
  if [ $CommandLine -eq 1 ];then                                                
        case $choice in                                                         
                'play') echo "Play Song"                                        
                       music=$( awk 'NR==n' n=$Song_Number $songs )             
                       echo ${music}                                            
                       mpg123 ${music} &                                        
                       FirstTimeFlag=1                                          
                       PlayingFlag=1                                            
                       button_state=1                                           
                       if [ $button_state -eq 0 ]                               
                         then                                                   
                          echo "play"                                           
                          killall -CONT mpg123                                  
                          PlayingFlag=1    
                          button_state=1                                        
                          sleep 0.4                                             
                       fi                                                       
                  ;;                                                            
                'pause')                                                        
                       if [ $button_state -eq 1 ]                               
                         then                                                   
                           echo "pause"                                         
                           killall -STOP  mpg123                                
                           PlayingFlag=0                                        
                           button_state=0                                       
                       fi                                                       
                  ;;                                                            
                'next')                                                         
                     echo "Next Song"                                           
                     if [ $PlayingFlag -eq 1 ] ; then                           
                                                                                
                      if [ $Song_Number -lt $song_counter ] ; then              
                        killall -KILL mpg123                                    
                        sleep 0.5                                               
                        Song_Number=$(($Song_Number+1))                         
                        echo "next line"                                        
                        echo ${Song_Number}    
                        echo "playing song"                                     
                        music=$( awk 'NR==n' n=$Song_Number $songs )            
                        echo ${music}                                           
                        mpg123 ${music} &                                       
                      else                                                      
                        echo "error this the last song"                         
                      fi                                                        
                    fi                                                          
                  ;;                                                            
                'previous')                                                     
                     echo "Prev"                                                
                     if [ $PlayingFlag -eq 1 ] ; then                           
                      if [ $Song_Number -gt $Min_NumberOfSong] ; then           
                        killall -KILL mpg123                                    
                        sleep 0.5                                               
                        Song_Number=$(($Song_Number-1))                         
                        echo "prev line"                                        
                        echo ${Song_Number}                                     
                        echo "playing prev song"                                
                        music=$( awk 'NR==n' n=$Song_Number $songs )            
                        echo ${music}                                           
                        mpg123 ${music} &                                       
                      else 
                        echo "error this is the last prev song"                 
                      fi                                                        
                    fi                                                          
                  ;;                                                            
                'shuffle')                                                      
                     echo "Shuffle"                                             
                     if [ $PlayingFlag -eq 1 ] ; then                           
                      Random_Line=$(((RANDOM%song_counter) + 1))                
                      echo "Random number"                                      
                      echo ${Random_Line}                                       
                      if [ $Random_Line -eq 0 ]; then                           
                         Random_Line=1                                          
                      fi                                                        
                                                                                
                      killall -KILL mpg123                                      
                      sleep 0.5                                                 
                      Song_Number=$Random_Line                                  
                      echo "Random line"                                        
                      echo ${Song_Number}                                       
                      echo "playing prev song"                                  
                      music=$( awk 'NR==n' n=$Song_Number $songs )              
                      echo ${music}                                             
                      mpg123 ${music} &    
                                                                                
                    fi                                                          
                  ;;                                                            
                  *) echo " Inviald input"                                      
                  ;;                                                            
    esac                                                                        
                                                                                
                                                                                
  elif [ $CommandLine -eq 0 ];then                                              
          #echo "Button input"                                                  
          if [ $(cat /sys/class/gpio/gpio4/value) == '1' ] ; then #if anyone pus
            #toggle button state                                                
            if [ $FirstTimeFlag -eq 0 ] ; then                                  
                                                                                
              music=$( awk 'NR==n' n=$Song_Number $songs )                      
              echo ${music}                                                     
              mpg123 ${music} &                                                 
              FirstTimeFlag=1                                                   
              PlayingFlag=1                                                     
              button_state=1                                                    
              sleep 0.5                                                         
              continue                                                          
            fi  
            if [ $button_state -eq 0 ]                                          
              then                                                              
              echo "play"                                                       
              killall -CONT mpg123                                              
              PlayingFlag=1                                                     
              button_state=1                                                    
              sleep 0.4                                                         
            elif [ $button_state -eq 1 ]                                        
              then                                                              
              echo "pause"                                                      
              killall -STOP  mpg123                                             
              PlayingFlag=0                                                     
              button_state=0                                                    
              sleep 0.4 # to allow finger release                               
            fi                                                                  
          fi                                                                    
                                                                                
          if [ $(cat /sys/class/gpio/gpio17/value) == '1' ] ; then #next        
             echo "next button"                                                 
             if [ $PlayingFlag -eq 1 ] ; then                                   
              echo $PlayingFlag                                                 
              echo ${Song_Number}                                               
              if [ $Song_Number -lt $song_counter ] ; then   
            killall -KILL mpg123                                            
                sleep 0.5                                                       
                Song_Number=$(($Song_Number+1))                                 
                echo "next line"                                                
                     echo ${Song_Number}                                        
                echo "playing song"                                             
                music=$( awk 'NR==n' n=$Song_Number $songs )                    
                echo ${music}                                                   
                mpg123 ${music} &                                               
              else                                                              
                echo "error this the last song"                                 
              fi                                                                
            fi                                                                  
          fi                                                                    
          if [ $(cat /sys/class/gpio/gpio18/value) == '1' ] ; then #prev        
             if [ $PlayingFlag -eq 1 ] ; then                                   
              if [ $Song_Number -gt $Min_NumberOfSong ] ; then                  
                killall -KILL mpg123                                            
                sleep 0.5                                                       
                Song_Number=$(($Song_Number-1))                                 
                echo "prev line"                                                
                echo ${Song_Number}                                             
                echo "playing prev song"   
                music=$( awk 'NR==n' n=$Song_Number $songs )                    
                echo ${music}                                                   
                mpg123 ${music} &                                               
              else                                                              
                        echo "error this is the last prev song"                 
              fi                                                                
            fi                                                                  
          fi                                                                    
          if [ $(cat /sys/class/gpio/gpio27/value) == '1' ] ; then #Shuffel     
             if [ $PlayingFlag -eq 1 ] ; then                                   
              Random_Line=$(((RANDOM%song_counter) + 1))                        
              echo "Random number"                                              
              echo ${Random_Line}                                               
              if [ $Random_Line -eq 0 ]; then                                   
                 Random_Line=1                                                  
              fi                                                                
                                                                                
              killall -KILL mpg123                                              
              sleep 0.5                                                         
              Song_Number=$Random_Line                                          
              echo "Random line"                                                
              echo ${Song_Number}                                               
              echo "playing prev song" 
              music=$( awk 'NR==n' n=$Song_Number $songs )                      
              echo ${music}                                                     
              mpg123 ${music} &                                                 
                                                                                
            fi                                                                  
          fi                                                                    
   fi                                                                           
done                                                                            
                                                                                
             
     
